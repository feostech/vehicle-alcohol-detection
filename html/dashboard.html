<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethanol detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        /* Custom styles */
        .navbar-brand {
            font-size: 1.25rem;
        }

        .signout-btn {
            background-color: #ffffff;
            border: none;
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .signout-btn img {
            width: 25px;
            height: 25px;
        }

        /* Style to make the signout button circular */
        .signout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-2">
        <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">Ethanol Level Detection</a>
        <button class="signout-btn" onclick="confirmSignOut()">
            <img src="sign-out-button.jpg" alt="Sign out">
        </button>
    </nav>
    <div class="container-fluid">
        <div id="status" class="alert">
            <small>Loading...</small>
        </div>
        <div class="row">
            <div class="col-12 col-md-7 mb-2">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title">
                            Ethanol Level
                            <span id="alcoholLevel" class="text-muted float-right badge">Unknown</span>
                        </div>
                        <canvas id="alcoholChart" width="300" height="120"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-5">
                <table class="table table-bordered table-sm table-striped mt-2">
                    <tbody>
                        <tr>
                            <th>Last MQTT message</th>
                            <td><small id="message">no message received</small></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"
        type="text/javascript"></script>

    <script>
        let mqttClient;
        let mqttTopic = "TOPIC";
        let alertCount = 0;

        function MQTTconnect() {
            mqttClient = new Paho.MQTT.Client("HOST", WEBSOCKET_PORT, "clientId" + new Date().getTime());
            mqttClient.onMessageArrived = onMessageArrived;
            mqttClient.connect({ onSuccess: onConnect });
        }

        function onConnect() {
            mqttClient.subscribe(mqttTopic);
            $("#status").html("Connected to MQTT server").attr("class", "alert alert-success");
        }

        function onMessageArrived(message) {
            let payload = message.payloadString;
            console.log("Received message:", payload);
            $("#message").text(payload); // Display received message in Last MQTT message section

            let alertMessage = $('<div class="alert alert-danger" role="alert">' + payload + '</div>');
            $(".card-body").append(alertMessage); // Append alert message to Ethanol Level card body

            playAlertSound(); // Play alert sound

            alertCount++;
            if (alertCount >= 5) {
                $(".alert-danger").fadeOut(500, function () {
                    $(this).remove(); // Remove the faded out alert messages
                });
                alertCount = 0;
            }

            setTimeout(function () {
                alertMessage.fadeOut(500, function () {
                    $(this).remove(); // Remove the faded out alert message after 5 seconds
                });
            }, 5000);
        }

        function playAlertSound() {
            let audio = new Audio('.mp3');
            audio.play();
        }

        function confirmSignOut() {
            if (confirm("Are you sure you want to sign out?")) {
                signOut();
            }
        }

        function signOut() {
            // Add your signout functionality here, such as redirecting to the login page or clearing session data
            console.log("User signed out");
            // For example, redirecting to the login page:
            window.location.href = "#";
        }

        $(document).ready(function () {
            MQTTconnect();
        });
    </script>

</body>

</html>
